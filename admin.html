<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin | Grameen Cooling Solution</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <script type="module">
    import {getOrders, saveOrders, STATUSES, statusClass} from './assets/js/app.js';

    const ADMIN_PIN = "1234"; // TODO: change this

    function renderTable(list){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      list.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${o.id}</b><br/><small class="muted">${new Date(o.createdAt).toLocaleString()}</small></td>
          <td>${o.name}<br/><small class="muted">${o.phone}</small></td>
          <td>${o.service}</td>
          <td><span class="${statusClass(o.status)}">${o.status}</span></td>
          <td>
            <select data-id="${o.id}" class="input">
              ${STATUSES.map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td><button class="btn ghost" data-vid="${o.id}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('select').forEach(sel=>{
        sel.addEventListener('change', (e)=>{
          const id = sel.getAttribute('data-id');
          const list = getOrders();
          const idx = list.findIndex(x=>x.id===id);
          if(idx>-1){
            list[idx].status = sel.value;
            list[idx].history = list[idx].history || [];
            list[idx].history.push({ts:new Date().toISOString(), note:`Status â†’ ${sel.value}`});
            saveOrders(list);
            renderTable(getOrders());
          }
        });
      });

      tbody.querySelectorAll('button[data-vid]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-vid');
          const o = getOrders().find(x=>x.id===id);
          alert(`Order ${o.id}\n${o.name} (${o.phone})\n${o.address}\nService: ${o.service}\nStatus: ${o.status}`);
        });
      });
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      const gate = document.getElementById('gate');
      const dash = document.getElementById('dash');
      document.getElementById('login').addEventListener('submit', (e)=>{
        e.preventDefault();
        const pin = document.getElementById('pin').value;
        if(pin===ADMIN_PIN){
          gate.style.display = 'none';
          dash.style.display = 'block';
          renderTable(getOrders());
        }else{
          alert('Wrong PIN');
        }
      });
    });
  </script>
</head>
<body>
  <nav class="nav">
    <div class="inner container">
      <div class="brand">
        <img src="assets/images/logo.png" alt="GCS"/>
        <div class="title">Grameen Cooling Solution</div>
      </div>
      <div class="menu">
        <a href="index.html">Home</a>
        <a href="booking.html">Book Service</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <div id="gate" class="card" style="max-width:420px;margin:30px auto">
      <div class="title">Admin Login</div>
      <form id="login">
        <div class="label">Enter PIN</div>
        <input class="input" id="pin" type="password" placeholder="4-digit PIN" required/>
        <button class="btn" style="margin-top:10px">Enter</button>
      </form>
      <div class="notice" style="margin-top:10px">Default PIN: 1234 (change in admin.html)</div>
    </div>

    <div id="dash" style="display:none">
      <div class="header">
        <h2>Orders</h2>
      </div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Order</th>
            <th>Customer</th>
            <th>Service</th>
            <th>Status</th>
            <th>Update</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
</body>
</html>
